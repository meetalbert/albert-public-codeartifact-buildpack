#!/usr/bin/env bash

set -euo pipefail

function log() {
    echo "-----> $*"
}

function indent() {
    sed -e 's/^/       /'
}

export BUILD_DIR="$1"
export ENV_DIR="$3"
BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)

shopt -s nullglob

for env_file in "$ENV_DIR"/AWS_CODEARTIFACT_* ; do
    export "$(basename "$env_file")=$(cat "$env_file" 2>/dev/null)"
done


# Set the AWS credentials to the CodeArtifact IAM role
export AWS_ACCESS_KEY_ID=$AWS_CODEARTIFACT_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY=$AWS_CODEARTIFACT_SECRET_ACCESS_KEY

CODEARTIFACT_AUTH_TOKEN_COMMAND="aws codeartifact get-authorization-token $AWS_CODEARTIFACT_GET_AUTHORIZATION_TOKEN_ARGS"
CODEARTIFACT_AUTH_TOKEN=$($CODEARTIFACT_AUTH_TOKEN_COMMAND)
EXTRA_INDEX_URL="https://aws:$CODEARTIFACT_AUTH_TOKEN@$AWS_CODEARTIFACT_URL"

if [ -w "$BP_DIR" ]; then
    log "setting PIP_EXTRA_INDEX_URL"
    echo "export PIP_EXTRA_INDEX_URL=\"$EXTRA_INDEX_URL\"" > "$BP_DIR/export"
fi
